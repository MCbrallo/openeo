<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Open EO Viewer — Explore • Compare • Animate • Analyze</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Leaflet core -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet.draw -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<!-- Helpers -->
<script src="https://cdn.jsdelivr.net/npm/leaflet-hash@0.2.1/leaflet-hash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.3/src/leaflet.geometryutil.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@2.9.0/dist/dom-to-image-more.min.js"></script>

<!-- Time & Compare (optional, already wired) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.control.min.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-side-by-side@2.0.1/leaflet-side-by-side.min.js"></script>

<style>
  :root {
    --bg: #0b1020;
    --panel: #11172b;
    --muted: #9fb0d0;
    --text: #e6ecff;
    --accent: #65b1ff;
    --line: rgba(255,255,255,.08);
  }
  * { box-sizing: border-box; }
  html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font: 14px/1.35 Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  a { color: var(--accent); text-decoration: none; }
  a:hover { text-decoration: underline; }
  /* Layout grid */
  .app {
    display: grid; height: 100vh; width: 100vw;
    grid-template-columns: 320px 1fr 360px; grid-template-rows: 56px 1fr;
    grid-template-areas:
      "header header header"
      "left   map    right";
  }
  header {
    grid-area: header; display:flex; align-items:center; justify-content:space-between;
    padding: 0 14px; background: #0e1630; border-bottom: 1px solid var(--line);
  }
  header .title { display:flex; gap:10px; align-items:center; }
  header .title h1 { font-size: 16px; margin:0; }
  header .actions { display:flex; gap:8px; align-items:center; }
  .btn {
    background:#1c2645; border:1px solid var(--line); color:var(--text);
    padding:6px 10px; border-radius:8px; cursor:pointer;
  }
  .btn:hover { background:#223059; }
  .btn.primary { background: var(--accent); color:#07111f; border-color:transparent; }
  .btn.primary:hover { filter: brightness(1.05); }

  /* Panels */
  .panel { background: var(--panel); border-right: 1px solid var(--line); padding: 10px; }
  .panel.right { border-left: 1px solid var(--line); border-right: none; }
  .panel h2 { font-size: 13px; letter-spacing:.02em; margin: 8px 0 6px; color: #cfe0ff; text-transform: uppercase; }
  .panel .muted { color: var(--muted); }
  .panel .hr { height:1px; background:var(--line); margin:10px 0; }

  /* Tabs (left) */
  .tabs { display:flex; gap:6px; margin-bottom:6px; }
  .tab-btn {
    flex:1; text-align:center; padding:6px; border-radius:8px; border:1px solid var(--line);
    background:#151d37; color:var(--text); cursor:pointer;
  }
  .tab-btn.active { background:#1d2749; border-color:#2e3f76; }
  .tab-content { display:none; }
  .tab-content.active { display:block; }
  .form { display:grid; gap:8px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  label { font-weight:600; font-size:12px; color:#cfe0ff; }
  select, input[type="date"], input[type="range"], input[type="number"], input[type="text"] {
    background:#0f1730; color:var(--text); border:1px solid var(--line); border-radius:8px; padding:6px 8px;
  }
  input[type="range"] { width: 150px; }
  .help { font-size:12px; color:var(--muted); }

  /* Map */
  #map { grid-area: map; height: 100%; width: 100%; }
  .left { grid-area: left; overflow:auto; }
  .right { grid-area: right; overflow:auto; }
  .legend { background:#0f1730; border:1px solid var(--line); border-radius:8px; padding:8px; text-align:center; }
  .legend img { max-width:100%; height:auto; }

  /* Bottom “trainers” */
  .hint { font-size:12px; color:#cde1ff; background:#142349; border:1px dashed #264987; padding:8px; border-radius:8px; }

  /* Mobile: sidebars become bottom sheets */
  @media (max-width: 1020px) {
    .app {
      grid-template-columns: 1fr; grid-template-rows: 56px 1fr 260px 260px;
      grid-template-areas:
        "header"
        "map"
        "left"
        "right";
    }
    .panel { border-right:none; border-top: 1px solid var(--line); }
    .panel.right { border-left:none; }
  }
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header>
    <div class="title">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="#65b1ff" aria-hidden="true"><circle cx="12" cy="12" r="10" opacity=".2"/><path d="M12 4a8 8 0 0 1 7.14 4.44L12 13 4.86 8.44A8 8 0 0 1 12 4Z"/></svg>
      <h1>Open EO Viewer</h1>
      <span class="muted">Explore • Compare • Animate • Analyze</span>
    </div>
    <div class="actions">
      <button class="btn" id="snapshotBtn">Snapshot</button>
      <button class="btn" id="bookmarkSave">Save Bookmark</button>
      <select id="bookmarkLoad"><option value="">Load…</option></select>
      <a class="btn" href="https://gibs.earthdata.nasa.gov/" target="_blank">Deploy/Docs</a>
    </div>
  </header>

  <!-- Left Panel: Tools -->
  <aside class="panel left">
    <h2>Tools</h2>
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-explore">Explore</button>
      <button class="tab-btn" data-tab="tab-compare">Compare</button>
      <button class="tab-btn" data-tab="tab-animate">Animate</button>
      <button class="tab-btn" data-tab="tab-analyze">Analyze</button>
    </div>

    <!-- Explore -->
    <section id="tab-explore" class="tab-content active">
      <div class="form">
        <div class="row">
          <label for="layer">Layer</label>
          <select id="layer">
            <optgroup label="True Color">
              <option value="VIIRS_SNPP_CorrectedReflectance_TrueColor">VIIRS SNPP True Color</option>
              <option value="VIIRS_NOAA20_CorrectedReflectance_TrueColor" selected>VIIRS NOAA-20 True Color</option>
              <option value="MODIS_Terra_CorrectedReflectance_TrueColor">MODIS Terra True Color</option>
            </optgroup>
          </select>
        </div>
        <div class="row">
          <label for="date">Date</label>
          <input type="date" id="date">
        </div>
        <div class="row">
          <label for="opacity">Opacity</label>
          <input type="range" id="opacity" min="0" max="1" step="0.05" value="1">
          <label><input type="checkbox" id="toggleOSM"> OSM basemap</label>
        </div>
        <div class="hint">Tip: press <b>[</b> and <b>]</b> to step the date by ±1 day.</div>
      </div>
    </section>

    <!-- Compare -->
    <section id="tab-compare" class="tab-content">
      <p class="help">Swipe between two layers or dates to see change.</p>
      <div class="form">
        <div class="row">
          <label>Left</label>
          <select id="leftLayer"></select>
          <input type="date" id="leftDate">
        </div>
        <div class="row">
          <label>Right</label>
          <select id="rightLayer"></select>
          <input type="date" id="rightDate">
        </div>
        <div class="row">
          <button class="btn primary" id="activateCompare">Activate Compare</button>
        </div>
      </div>
    </section>

    <!-- Animate -->
    <section id="tab-animate" class="tab-content">
      <p class="help">Play a time-lapse for the selected layer.</p>
      <div class="form">
        <div class="row">
          <label for="animLayer">Layer</label>
          <select id="animLayer"></select>
        </div>
        <div class="row">
          <button class="btn primary" id="activateAnimate">Activate Animation</button>
        </div>
        <div class="hint">After activation, the time slider appears on the map (bottom-left).</div>
      </div>
    </section>

    <!-- Analyze -->
    <section id="tab-analyze" class="tab-content">
      <p class="help">Draw rectangles or polygons, then export or analyze them.</p>
      <div class="form">
        <div class="row">
          <button class="btn" id="exportGeoJSON">Export GeoJSON</button>
          <label class="btn" for="importGeoJSON">Import GeoJSON</label>
          <input id="importGeoJSON" type="file" accept=".geojson,.json" style="display:none">
        </div>
        <div class="row">
          <button class="btn primary" id="analyzeAOI">Analyze AOI</button>
          <span id="aoiStatus" class="muted">no AOI selected</span>
        </div>
        <div class="hr"></div>
        <div id="aoiResults" class="help">Mean RGB / brightness will appear here after analysis.</div>
      </div>
    </section>
  </aside>

  <!-- Map -->
  <main id="map"></main>

  <!-- Right Panel: Learn -->
  <aside class="panel right">
    <h2>Learn</h2>
    <div class="help">
      <p><b>VIIRS SNPP / NOAA-20</b> — Daily global imagery at ~375 m for visible bands. Great for smoke, storms, large-scale features.</p>
      <p><b>MODIS Terra</b> — Long-running mission with global daily coverage at 250–1000 m. Useful for historical context.</p>
      <p><b>GIBS (NASA)</b> serves many layers (true color, fires, snow/ice, aerosols). This app uses <b>WMS</b> to request tiles by <b>date</b> and <b>layer</b>.</p>
      <p>Use <b>Explore</b> to inspect a single date, <b>Compare</b> to swipe between dates/layers, <b>Animate</b> for time-lapse, and <b>Analyze</b> to draw AOIs and export GeoJSON.</p>
    </div>
    <div class="hr"></div>
    <h2>Legend</h2>
    <div id="legend" class="legend"><em>No legend for this layer.</em></div>
    <div class="hr"></div>
    <div class="hint">Pro tip: share your exact view using the URL — it encodes map position and state.</div>
  </aside>
</div>

<script>
  // ====== Small helpers ======
  const $ = sel => document.querySelector(sel);
  const todayISO = new Date().toISOString().slice(0,10);
  const defaultDateISO = '2025-06-06';
  const GIBS_WMS = 'https://gibs.earthdata.nasa.gov/wms/epsg3857/best/wms.cgi?';

  // ====== Tabs logic (no overlap; each tool has its own space) ======
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      $('#'+btn.dataset.tab).classList.add('active');
    });
  });

  // ====== Map setup ======
  const map = L.map('map', { center:[20,0], zoom:3, timeDimension:true, timeDimensionControl:false });
  map.zoomControl.setPosition('bottomleft');
  new L.Hash(map);
  L.control.scale({imperial:false}).addTo(map);
  map.attributionControl.setPrefix(false);
  map.attributionControl.addAttribution('Imagery © NASA EOSDIS GIBS · © Leaflet & OSM');

  // Optional basemap
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap' });

  // Overlays for context
  const overlays = L.tileLayer.wms(GIBS_WMS, { layers:'Coastlines,Reference_Features', format:'image/png', transparent:true, version:'1.3.0' }).addTo(map);

  // Draw/AOI layer
  const drawnItems = new L.FeatureGroup().addTo(map);
  const drawControl = new L.Control.Draw({
    position:'bottomleft',
    edit: { featureGroup: drawnItems },
    draw: { polygon: { allowIntersection:false, showArea:true }, rectangle:true, marker:false, circle:false, circlemarker:false, polyline:false }
  });
  map.addControl(drawControl);
  map.on(L.Draw.Event.CREATED, e=>{
    drawnItems.addLayer(e.layer);
    if (e.layer instanceof L.Polygon || e.layer instanceof L.Rectangle) {
      const rings = e.layer.getLatLngs()[0], m2 = L.GeometryUtil.geodesicArea(rings);
      e.layer.bindTooltip(`${(m2/1e6).toFixed(2)} km²`).openTooltip();
      $('#aoiStatus').textContent = 'AOI ready';
    }
  });

  // ====== Imagery layers ======
  function buildWMS(layerId, dateISO){
    return L.tileLayer.wms(GIBS_WMS, {
      layers: layerId, format:'image/jpeg', transparent:false, version:'1.3.0',
      time: dateISO || todayISO, crossOrigin:'anonymous'
    });
  }
  let singleLayer = null;
  function setSingleLayer(layerId, dateISO){
    if (singleLayer) map.removeLayer(singleLayer);
    singleLayer = buildWMS(layerId, dateISO).addTo(map);
    singleLayer.setOpacity(parseFloat($('#opacity').value || '1'));
    updateLegend(layerId);
  }

  // ====== Compare (side-by-side) ======
  let leftL=null, rightL=null, sbs=null;
  function activateCompare(){
    if (singleLayer){ map.removeLayer(singleLayer); singleLayer=null; }
    if (sbs){ map.removeControl(sbs); sbs=null; }
    if (leftL) map.removeLayer(leftL);
    if (rightL) map.removeLayer(rightL);
    leftL  = buildWMS($('#leftLayer').value,  $('#leftDate').value).addTo(map);
    rightL = buildWMS($('#rightLayer').value, $('#rightDate').value).addTo(map);
    const op = parseFloat($('#opacity').value || '1'); leftL.setOpacity(op); rightL.setOpacity(op);
    sbs = L.control.sideBySide(leftL, rightL).addTo(map);
    updateLegend(null); // ambiguous in compare
  }

  // ====== Animate (TimeDimension) ======
  let tdLayer=null, tdCtrl=null;
  function activateAnimate(){
    if (singleLayer){ map.removeLayer(singleLayer); singleLayer=null; }
    if (sbs){ map.removeControl(sbs); sbs=null; }
    if (tdLayer){ map.removeLayer(tdLayer); tdLayer=null; }
    const base = L.tileLayer.wms(GIBS_WMS, { layers: $('#animLayer').value, format:'image/jpeg', version:'1.3.0', transparent:false, crossOrigin:'anonymous' });
    tdLayer = L.timeDimension.layer.wms(base, { updateTimeDimension:true, requestTimeFromCapabilities:false, cache:8 }).addTo(map);
    if (!tdCtrl) {
      tdCtrl = new L.Control.TimeDimension({ position:'bottomleft', timeSliderDragUpdate:true, playerOptions: { transitionTime: 500 }});
      map.addControl(tdCtrl);
    }
    updateLegend($('#animLayer').value);
  }

  // ====== Legend ======
  async function updateLegend(layerId){
    const box = $('#legend');
    if (!layerId || /TrueColor/i.test(layerId)) { box.innerHTML = '<em>No legend for this layer.</em>'; return; }
    const url = GIBS_WMS + `SERVICE=WMS&REQUEST=GetLegendGraphic&FORMAT=image/png&LAYER=${encodeURIComponent(layerId)}`;
    box.innerHTML = `<img alt="Legend" src="${url}">`;
  }

  // ====== UI bindings: Explore ======
  $('#date').value = defaultDateISO;
  $('#date').min = '2000-01-01'; $('#date').max = todayISO;
  setSingleLayer($('#layer').value, $('#date').value);
  $('#layer').addEventListener('change', ()=> setSingleLayer($('#layer').value, $('#date').value));
  $('#date').addEventListener('change', ()=> singleLayer && singleLayer.setParams({ time: $('#date').value || todayISO }));
  $('#opacity').addEventListener('input', ()=> {
    const v = parseFloat($('#opacity').value);
    if (singleLayer) singleLayer.setOpacity(v);
    if (leftL) leftL.setOpacity(v);
    if (rightL) rightL.setOpacity(v);
    if (tdLayer) tdLayer.setOpacity(v);
  });
  $('#toggleOSM').addEventListener('change', e=>{
    if (e.target.checked) { osm.addTo(map); if (singleLayer) singleLayer.bringToFront(); if (leftL&&rightL){ leftL.bringToFront(); rightL.bringToFront(); } overlays.bringToFront(); }
    else { map.removeLayer(osm); }
  });
  document.addEventListener('keydown', e=>{ if (e.key==='['||e.key===']'){ const d=new Date($('#date').value||todayISO); d.setUTCDate(d.getUTCDate() + (e.key==='['?-1:1)); const iso=d.toISOString().slice(0,10); $('#date').value=iso; singleLayer && singleLayer.setParams({time:iso}); } });

  // ====== Populate Compare/Animate selects from main layer list ======
  function cloneLayerOptions(from, to){ to.innerHTML = from.innerHTML; }
  cloneLayerOptions($('#layer'), $('#leftLayer'));
  cloneLayerOptions($('#layer'), $('#rightLayer'));
  cloneLayerOptions($('#layer'), $('#animLayer'));
  $('#leftLayer').value=$('#layer').value; $('#rightLayer').value=$('#layer').value;
  $('#leftDate').value=$('#date').value;   $('#rightDate').value=$('#date').value;
  $('#activateCompare').addEventListener('click', activateCompare);
  $('#activateAnimate').addEventListener('click', activateAnimate);

  // ====== Analyze ======
  $('#exportGeoJSON').addEventListener('click', ()=>{
    const fc = drawnItems.toGeoJSON();
    const blob = new Blob([JSON.stringify(fc, null, 2)], {type:'application/geo+json'});
    const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'aoi.geojson'}); a.click();
    URL.revokeObjectURL(a.href);
  });
  $('#importGeoJSON').addEventListener('change', async (ev)=>{
    const f = ev.target.files?.[0]; if (!f) return;
    try { const txt=await f.text(); L.geoJSON(JSON.parse(txt)).eachLayer(l=>drawnItems.addLayer(l)); $('#aoiStatus').textContent='AOI imported'; }
    catch { $('#aoiStatus').textContent='Invalid GeoJSON'; }
    ev.target.value='';
  });
  $('#analyzeAOI').addEventListener('click', ()=>{
    // Minimal “intuitive” feedback; you can plug your histogram/time-series logic here.
    let poly=null; drawnItems.eachLayer(l=>{ if (!poly && (l instanceof L.Polygon || l instanceof L.Rectangle)) poly=l; });
    if (!poly) { $('#aoiStatus').textContent='Draw a polygon/rectangle first'; return; }
    const rings = poly.getLatLngs()[0], m2 = L.GeometryUtil.geodesicArea(rings);
    $('#aoiResults').innerHTML = `<b>Area:</b> ${(m2/1e6).toFixed(2)} km²<br><span class="muted">Advanced stats: mean RGB, histograms, time series — can be enabled as in your previous version.</span>`;
  });

  // ====== Snapshot & Bookmarks ======
  $('#snapshotBtn').addEventListener('click', ()=>{
    domtoimage.toPng($('#map')).then(url=>{
      const a = Object.assign(document.createElement('a'), {href:url, download:`map_${new Date().toISOString().slice(0,10)}.png`}); a.click();
    });
  });
  const BM_KEY='oeo_bookmarks_v2';
  function loadBMs(){
    const arr = JSON.parse(localStorage.getItem(BM_KEY) || '[]');
    const sel = $('#bookmarkLoad'); sel.innerHTML='<option value="">Load…</option>';
    arr.forEach((b,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=b.name; sel.appendChild(o); });
    return arr;
  }
  function saveBM(){
    const arr=loadBMs();
    const name = prompt('Bookmark name?', `View ${arr.length+1}`) || `View ${arr.length+1}`;
    arr.push({ name, center: map.getCenter(), zoom: map.getZoom(), layer: $('#layer').value, date: $('#date').value });
    localStorage.setItem(BM_KEY, JSON.stringify(arr)); loadBMs();
  }
  $('#bookmarkSave').addEventListener('click', saveBM);
  $('#bookmarkLoad').addEventListener('change', ()=>{
    const arr=loadBMs(); const i=parseInt($('#bookmarkLoad').value,10);
    if (!isNaN(i) && arr[i]){ const b=arr[i]; map.setView(b.center,b.zoom); $('#layer').value=b.layer; $('#date').value=b.date; setSingleLayer(b.layer,b.date); }
    $('#bookmarkLoad').value='';
  });
  loadBMs();

  // ====== Legend initial ======
  updateLegend($('#layer').value);
</script>
</body>
</html>
