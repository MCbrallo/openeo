<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Open EO Viewer — Explore • Compare • Animate • Analyze</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Leaflet core -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet.draw -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<!-- Helpers -->
<script src="https://cdn.jsdelivr.net/npm/leaflet-hash@0.2.1/leaflet-hash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.3/src/leaflet.geometryutil.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@2.9.0/dist/dom-to-image-more.min.js"></script>

<!-- Compare -->
<script src="https://cdn.jsdelivr.net/npm/leaflet-side-by-side@2.0.1/leaflet-side-by-side.min.js"></script>

<!-- GIF export (client-side) -->
<script src="https://cdn.jsdelivr.net/npm/gif.js.optimized@0.2.0/dist/gif.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gif.js.optimized@0.2.0/dist/gif.worker.js"></script>

<style>
  :root {
    --bg: #0b1020;
    --panel: #11172b;
    --muted: #9fb0d0;
    --text: #e6ecff;
    --accent: #65b1ff;
    --line: rgba(255,255,255,.08);
    --danger: #ff6574;
  }
  * { box-sizing: border-box; }
  html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font: 14px/1.35 Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  a { color: var(--accent); text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* Layout grid */
  .app {
    display: grid; height: 100vh; width: 100vw;
    grid-template-columns: 340px 1fr; grid-template-rows: 56px 1fr;
    grid-template-areas:
      "header header"
      "left   map";
  }
  header {
    grid-area: header; display:flex; align-items:center; justify-content:space-between;
    padding: 0 14px; background: #0e1630; border-bottom: 1px solid var(--line);
    z-index: 3;
  }
  header .title { display:flex; gap:10px; align-items:center; }
  header .title h1 { font-size: 16px; margin:0; }
  header .actions { display:flex; gap:8px; align-items:center; }
  .btn {
    background:#1c2645; border:1px solid var(--line); color:var(--text);
    padding:6px 10px; border-radius:8px; cursor:pointer;
  }
  .btn:hover { background:#223059; }
  .btn.primary { background: var(--accent); color:#07111f; border-color:transparent; }
  .btn.primary:hover { filter: brightness(1.05); }
  .btn.ghost { background: transparent; border-color: var(--line); }
  .btn.icon { display:flex; align-items:center; gap:6px; }

  /* Panels */
  .panel { background: var(--panel); border-right: 1px solid var(--line); padding: 10px; }
  .panel h2 { font-size: 13px; letter-spacing:.02em; margin: 8px 0 6px; color: #cfe0ff; text-transform: uppercase; }
  .panel .muted { color: var(--muted); }
  .panel .hr { height:1px; background:var(--line); margin:10px 0; }
  .left { grid-area: left; overflow:auto; z-index: 2; }

  /* Tabs */
  .tabs { display:flex; gap:6px; margin-bottom:6px; position: sticky; top: 0; background:var(--panel); padding-bottom: 6px; z-index: 2; }
  .tab-btn {
    flex:1; text-align:center; padding:6px; border-radius:8px; border:1px solid var(--line);
    background:#151d37; color:var(--text); cursor:pointer;
  }
  .tab-btn.active { background:#1d2749; border-color:#2e3f76; }
  .tab-content { display:none; }
  .tab-content.active { display:block; }

  /* Form */
  .form { display:grid; gap:10px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  label { font-weight:600; font-size:12px; color:#cfe0ff; }
  select, input[type="date"], input[type="range"], input[type="number"], input[type="text"] {
    background:#0f1730; color:var(--text); border:1px solid var(--line); border-radius:8px; padding:6px 8px;
  }
  input[type="range"] { width: 150px; }
  .help { font-size:12px; color: var(--muted); }
  .chip { display:inline-block; padding:2px 6px; border-radius:999px; background:#142349; color:#cde1ff; font-size:12px; }

  /* Map */
  #map { grid-area: map; height: 100%; width: 100%; position: relative; z-index: 1; }
  .legend { background:#0f1730; border:1px solid var(--line); border-radius:8px; padding:8px; text-align:center; }
  .legend img { max-width:100%; height:auto; }

  /* Learn Drawer & Modal (always above map) */
  .learn-drawer {
    position: fixed; right: 12px; top: 64px; bottom: 12px; width: 380px; max-width: 94vw;
    background: rgba(17,23,43,.98); backdrop-filter: blur(6px);
    border: 1px solid var(--line); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.3);
    display: none; z-index: 2000000000; padding: 12px; overflow:auto;
  }
  .learn-drawer.open { display:block; }
  .learn-search { width:100%; margin-bottom:8px; }
  .learn-section { border:1px solid var(--line); border-radius:10px; padding:8px; margin-bottom:8px; background:#0f1730; }
  .kbd { background:#0c1636; border:1px solid #263b80; padding:1px 6px; border-radius:6px; font-size:12px; }
  .modal { position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center;
           z-index: 2147483647; }
  .modal.open { display:flex; }
  .modal .modal-body {
    width: min(900px, 95vw); max-height: 90vh; overflow:auto;
    background:#101a36; border: 1px solid var(--line); border-radius: 12px; padding: 16px;
  }

  /* Layer stack */
  .stack { display:grid; gap:8px; }
  .stack-item {
    border:1px solid var(--line); border-radius:10px; padding:8px; background:#0f1730;
    display:grid; gap:6px;
  }
  .stack-item .row-top { display:flex; align-items:center; gap:8px; justify-content:space-between; }
  .stack-item .title { font-weight:600; font-size:13px; }
  .stack-item .controls { display:flex; gap:6px; align-items:center; }
  .icon-btn { background:#162045; border:1px solid var(--line); color:var(--text); border-radius:8px; padding:4px 6px; cursor:pointer; }
  .icon-btn:hover { background:#1b2959; }
  .danger { border-color:#52222a; background:#281318; color:#ff9aa5; }

  /* Toast */
  .toast {
    position: fixed; z-index: 40; right: 12px; bottom: 12px;
    padding: 8px 10px; background: rgba(0,0,0,.85); color: #fff; border-radius: 8px; display:none;
  }

  /* Overlays: loader and GIF */
  .preload-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,.75);
    display: none; align-items: center; justify-content: center; flex-direction: column;
    color: #fff; z-index: 2000000001;
    pointer-events: none; /* not blocking unless open */
  }
  .preload-overlay.open { display:flex; pointer-events: auto; }
  .preload-box {
    background: #0e1630; border: 1px solid var(--line); border-radius: 12px; padding: 16px; min-width: 300px; text-align: center;
  }
  #animGif {
    position: absolute;
    inset: 0;
    margin: auto;
    max-width: 100%;
    max-height: 100%;
    z-index: 5000; /* above map, below modal */
    display:none;
    pointer-events: none; /* never blocks clicks */
  }
  #animGif[data-visible="1"] { display:block; }
  #animGifClose {
    display:none;
    position:absolute;
    right:12px;
    top:12px;
    z-index:5001;
    pointer-events:auto;
  }

  /* Mobile */
  @media (max-width: 1000px) {
    .app {
      grid-template-columns: 1fr; grid-template-rows: 56px 1fr auto;
      grid-template-areas:
        "header"
        "map"
        "left";
    }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="#65b1ff" aria-hidden="true"><circle cx="12" cy="12" r="10" opacity=".2"/><path d="M12 4a 8 8 0 0 1 7.14 4.44L12 13 4.86 8.44A8 8 0 0 1 12 4Z"/></svg>
      <h1>Open EO Viewer</h1>
      <span class="muted">Explore • Compare • Animate • Analyze</span>
      <button class="btn icon" id="openLearn">?</button>
      <button class="btn icon" id="openLearnModal">Learn page</button>
    </div>
    <div class="actions">
      <button class="btn" id="snapshotBtn">Snapshot</button>
      <button class="btn" id="bookmarkSave">Save Bookmark</button>
      <select id="bookmarkLoad"><option value="">Load…</option></select>
    </div>
  </header>

  <!-- Left Panel: Tools -->
  <aside class="panel left">
    <h2>Tools</h2>
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-explore">Explore</button>
      <button class="tab-btn" data-tab="tab-compare">Compare</button>
      <button class="tab-btn" data-tab="tab-animate">Animate</button>
      <button class="tab-btn" data-tab="tab-analyze">Analyze</button>
    </div>

    <!-- Explore -->
    <section id="tab-explore" class="tab-content active">
      <div class="form">
        <div class="row">
          <label for="catalogFilter">Find layer</label>
          <input type="text" id="catalogFilter" placeholder="type to filter…">
        </div>
        <div class="row">
          <label for="catalog">Catalog</label>
          <select id="catalog" size="6" style="min-width:300px; max-width:100%"></select>
        </div>
        <div class="row">
          <button class="btn" id="addToStack">Add to stack</button>
          <label for="date">Date</label>
          <input type="date" id="date">
          <label><input type="checkbox" id="toggleOSM"> OSM</label>
        </div>
        <div class="row">
          <label for="globalOpacity">Global opacity</label>
          <input type="range" id="globalOpacity" min="0" max="1" step="0.05" value="1">
          <span class="help">applies to the top active layer</span>
        </div>
        <div class="hr"></div>
        <h2>Layer Stack</h2>
        <div id="stack" class="stack"></div>
        <div class="help">Stack multiple layers (e.g., Fires over True Color). Use ↑/↓ to reorder; each layer has its own opacity & toggle.</div>
      </div>
    </section>

    <!-- Compare -->
    <section id="tab-compare" class="tab-content">
      <p class="help">Swipe between two layers or dates to see change.</p>
      <div class="form">
        <div class="row">
          <label>Left</label>
          <select id="leftLayer"></select>
          <input type="date" id="leftDate">
        </div>
        <div class="row">
          <label>Right</label>
          <select id="rightLayer"></select>
          <input type="date" id="rightDate">
        </div>
        <div class="row">
          <button class="btn primary" id="activateCompare">Activate Compare</button>
        </div>
      </div>
    </section>

    <!-- Animate -->
    <section id="tab-animate" class="tab-content">
      <p class="help">Build a GIF for smooth playback & export. Choose <b>start/end</b>, <b>step</b>, <b>units</b>, then <b>Play</b>.</p>
      <div class="form">
        <div class="row">
          <label for="animFilter">Find mode</label>
          <input type="text" id="animFilter" placeholder="type to filter…">
        </div>
        <div class="row">
          <label for="animLayer">Layer</label>
          <select id="animLayer"></select>
        </div>
        <div class="row">
          <label>Start</label><input type="date" id="animStart">
          <label>End</label><input type="date" id="animEnd">
        </div>
        <div class="row">
          <label>Step</label><input type="number" id="animStep" value="1" min="1" style="width:70px">
          <select id="animUnits">
            <option>days</option>
            <option>weeks</option>
            <option>hours</option>
            <option>minutes</option>
            <option>seconds</option>
          </select>
        </div>
        <div class="row">
          <label>Speed (ms/frame)</label><input type="number" id="animSpeed" value="500" min="50" step="50" style="width:90px">
          <label><input type="checkbox" id="animLoop" checked> Loop</label>
          <label><input type="checkbox" id="animPingPong"> Ping-Pong</label>
        </div>
        <div class="row">
          <button class="btn" id="animPrebuild">Prebuild</button>
          <button class="btn primary" id="animPlay">Play</button>
          <button class="btn" id="animPause">Pause</button>
          <button class="btn" id="animDownloadGIF" disabled>Download GIF</button>
        </div>
        <div class="row">
          <progress id="animProgress" value="0" max="100" style="width:100%"></progress>
          <span id="animCurrent" class="chip">—</span>
        </div>
      </div>
    </section>

    <!-- Analyze -->
    <section id="tab-analyze" class="tab-content">
      <p class="help">Draw rectangles or polygons, then export or import them as GeoJSON.</p>
      <div class="form">
        <div class="row">
          <button class="btn" id="exportGeoJSON">Export GeoJSON</button>
          <label class="btn" for="importGeoJSON">Import GeoJSON</label>
          <input id="importGeoJSON" type="file" accept=".geojson,.json" style="display:none">
          <button class="btn" id="snapshotBtn2">Snapshot</button>
        </div>
        <div id="aoiStatus" class="help">No AOI selected.</div>
      </div>
    </section>
  </aside>

  <!-- Map -->
  <main id="map">
    <!-- GIF overlay (never blocks clicks when hidden) -->
    <img id="animGif" alt="Animation" />
    <button id="animGifClose" class="btn ghost">Close GIF</button>
  </main>
</div>

<!-- Learn Drawer -->
<div class="learn-drawer" id="learnDrawer" aria-label="Learn panel" tabindex="-1">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <h3>Learn</h3>
    <button class="btn ghost" id="closeLearn">Close</button>
  </div>
  <input class="learn-search" id="learnSearch" placeholder="Search…">
  <div id="learnContent"></div>
  <div class="help">Press <span class="kbd">?</span> to toggle, <span class="kbd">Esc</span> to close.</div>
</div>

<!-- Learn Modal (full page) -->
<div class="modal" id="learnModal" aria-modal="true" role="dialog">
  <div class="modal-body">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h2>Open EO — Learn</h2>
      <button class="btn" id="closeLearnModal">Close</button>
    </div>
    <div id="learnModalContent"></div>
  </div>
</div>

<!-- Preload overlay -->
<div class="preload-overlay" id="preloadOverlay">
  <div class="preload-box">
    <div id="preloadText">Preparing frames…</div>
    <progress id="preloadProgress" value="0" max="100" style="width:100%; margin-top:10px;"></progress>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/* ==========================
   Constants & Utilities
   ========================== */
const $ = sel => document.querySelector(sel);
const todayISO = new Date().toISOString().slice(0,10);
const defaultDateISO = todayISO;
const GIBS_WMS = 'https://gibs.earthdata.nasa.gov/wms/epsg3857/best/wms.cgi?';
const showToast = (msg, ms=2200) => {
  const t = $('#toast'); t.textContent = msg; t.style.display='block';
  clearTimeout(showToast._t); showToast._t = setTimeout(()=>t.style.display='none', ms);
};

/* ==========================
   Map setup
   ========================== */
const map = L.map('map', { center:[20,0], zoom:3 });
map.zoomControl.setPosition('bottomleft');
new L.Hash(map);
L.control.scale({imperial:false}).addTo(map);
map.attributionControl.setPrefix(false);
map.attributionControl.addAttribution('Imagery © NASA EOSDIS GIBS · © Leaflet & OSM');
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap' });

const overlays = L.tileLayer.wms(GIBS_WMS, { layers:'Coastlines,Reference_Features', format:'image/png', transparent:true, version:'1.3.0' }).addTo(map);

// Draw/AOI
const drawnItems = new L.FeatureGroup().addTo(map);
const drawControl = new L.Control.Draw({
  position:'bottomleft',
  edit: { featureGroup: drawnItems },
  draw: { polygon: { allowIntersection:false, showArea:true }, rectangle:true, marker:false, circle:false, circlemarker:false, polyline:false }
});
map.addControl(drawControl);
map.on(L.Draw.Event.CREATED, e=>{
  drawnItems.addLayer(e.layer);
  if (e.layer instanceof L.Polygon || e.layer instanceof L.Rectangle) {
    const rings = e.layer.getLatLngs()[0], m2 = L.GeometryUtil.geodesicArea(rings);
    e.layer.bindTooltip(`${(m2/1e6).toFixed(2)} km²`).openTooltip();
    $('#aoiStatus').textContent = 'AOI ready';
  }
});

/* ==========================
   Catalog (auto) + Grouping + Popular top-10
   ========================== */
const groups = {
  "Popular": [],
  "True Color": [ /TrueColor/i ],
  "Infrared (IR)": [ /IR|Infrared|Brightness[_ ]?Temp/i ],
  "Fires/Hotspots": [ /Fire|Fires|Thermal Anomalies/i ],
  "Snow & Ice": [ /Snow|Ice|Sea[_ ]?Ice|SIC/i ],
  "Aerosol/Atmosphere": [ /Aerosol|AOD|SO2|NO2|Ozone|CO Total Column/i ],
  "Night Lights": [ /Night|DNB|Nighttime/i ],
  "Ocean/SST/Color": [ /SST|Chlorophyll|Ocean|Sea Surface/i ],
  "Other": [ /.*/ ]
};
let catalogList = []; // {name, title, group}
let popularList = [];

function matchGroup(titleOrName){
  for (const [g, regs] of Object.entries(groups)){
    if (g === 'Popular') continue;
    if (regs.some(rx => rx.test(titleOrName))) return g;
  }
  return "Other";
}
function buildPopular(list){
  const wanted = [
    /NOAA.?20.*True.*Color/i,
    /SNPP.*True.*Color/i,
    /MODIS.*Terra.*True.*Color/i,
    /Thermal.*Anomalies|Fires.*375m/i,
    /Snow.*Cover/i,
    /Sea.*Ice.*Concentration/i,
    /Night.*(Lights|Night.?Band|DNB)/i,
    /Aerosol|AOD/i,
    /Sea.*Surface.*Temperature|SST/i,
    /Infrared|Brightness.*Temp/i
  ];
  const picks = [];
  for (const rx of wanted){
    const found = list.find(it => rx.test(it.title) || rx.test(it.name));
    if (found && !picks.some(p => p.name === found.name)) picks.push(found);
    if (picks.length >= 10) break;
  }
  return picks;
}

async function populateCatalog(){
  try{
    const url = GIBS_WMS + 'SERVICE=WMS&REQUEST=GetCapabilities';
    const res = await fetch(url); const text = await res.text();
    const xml = new DOMParser().parseFromString(text, 'application/xml');
    const layers = Array.from(xml.getElementsByTagName('Layer')).filter(n => n.getElementsByTagName('Name')[0]);

    const list = [];
    for (const Lyr of layers){
      const name = Lyr.getElementsByTagName('Name')[0]?.textContent || '';
      const title = Lyr.getElementsByTagName('Title')[0]?.textContent || name;
      if (!name) continue;
      const g = matchGroup(`${name} ${title}`);
      list.push({ name, title, group: g });
    }
    const seen = new Set(); catalogList = [];
    list.forEach(item => { if (!seen.has(item.name)){ seen.add(item.name); catalogList.push(item); } });
    catalogList.sort((a,b)=> (a.group===b.group) ? a.title.localeCompare(b.title) : a.group.localeCompare(b.group));

    popularList = buildPopular(catalogList);

    renderCatalog();
    syncCompareAnimateSelects();
    $('#date').value = defaultDateISO;
    setStackBase('VIIRS_NOAA20_CorrectedReflectance_TrueColor', defaultDateISO);
  } catch(e){
    console.warn('Capabilities fetch failed', e);
  }
}
function renderCatalog(){
  const sel = $('#catalog'); sel.innerHTML = '';
  if (popularList.length){
    const og = document.createElement('optgroup'); og.label = 'Popular';
    popularList.forEach(item=>{
      const opt = document.createElement('option'); opt.value=item.name; opt.textContent=item.title;
      og.appendChild(opt);
    });
    sel.appendChild(og);
  }
  let currentGroup = null;
  catalogList.forEach(item=>{
    if (popularList.some(p=>p.name===item.name)) return;
    if (item.group !== currentGroup){
      const optg = document.createElement('optgroup'); optg.label = item.group; sel.appendChild(optg);
      currentGroup = item.group;
    }
    const opt = document.createElement('option');
    opt.value = item.name; opt.textContent = item.title;
    sel.lastChild.appendChild(opt);
  });
}
$('#catalogFilter').addEventListener('input', ()=>{
  const q = $('#catalogFilter').value.toLowerCase();
  const sel = $('#catalog'); sel.innerHTML = '';
  const pop = popularList.filter(it => it.title.toLowerCase().includes(q) || it.name.toLowerCase().includes(q));
  if (pop.length){
    const og = document.createElement('optgroup'); og.label='Popular';
    pop.forEach(item=>{ const opt=document.createElement('option'); opt.value=item.name; opt.textContent=item.title; og.appendChild(opt); });
    sel.appendChild(og);
  }
  let current = null;
  catalogList.filter(it => !popularList.some(p=>p.name===it.name))
    .filter(it => it.title.toLowerCase().includes(q) || it.name.toLowerCase().includes(q))
    .forEach(item=>{
      if (item.group !== current){
        const optg = document.createElement('optgroup'); optg.label = item.group; sel.appendChild(optg);
        current = item.group;
      }
      const opt = document.createElement('option'); opt.value=item.name; opt.textContent=item.title;
      sel.lastChild.appendChild(opt);
    });
});
function cloneCatalogTo(selectEl){
  const tmp = document.createElement('select');
  if (popularList.length){
    const og = document.createElement('optgroup'); og.label='Popular';
    popularList.forEach(item=>{ const o=document.createElement('option'); o.value=item.name; o.textContent=item.title; og.appendChild(o); });
    tmp.appendChild(og);
  }
  let current = null;
  catalogList.forEach(item=>{
    if (popularList.some(p=>p.name===item.name)) return;
    if (item.group !== current){
      const optg = document.createElement('optgroup'); optg.label = item.group; tmp.appendChild(optg);
      current = item.group;
    }
    const opt = document.createElement('option'); opt.value=item.name; opt.textContent=item.title; tmp.lastChild.appendChild(opt);
  });
  selectEl.innerHTML = tmp.innerHTML;
  const def = 'VIIRS_NOAA20_CorrectedReflectance_TrueColor';
  if ([...selectEl.options].some(o=>o.value===def)) selectEl.value=def;
}

/* ==========================
   Layer creation helpers
   ========================== */
function buildWMS(layerId, dateISO){
  return L.tileLayer.wms(GIBS_WMS, {
    layers: layerId, format:'image/png',
    transparent:true, version:'1.3.0',
    time: dateISO || todayISO, crossOrigin:'anonymous', updateWhenIdle: true
  });
}
function legendURL(layerId){
  return GIBS_WMS + `SERVICE=WMS&REQUEST=GetLegendGraphic&FORMAT=image/png&LAYER=${encodeURIComponent(layerId)}`;
}

/* ==========================
   Layer Stack (Explore)
   ========================== */
const stackState = []; // [{id, title, layer, opacity, visible, date}]
function setStackBase(layerId, dateISO){ addLayerToStack(layerId, dateISO); }
function addLayerToStack(layerId, dateISO){
  const meta = catalogList.find(x=>x.name===layerId) || popularList.find(x=>x.name===layerId) || {title:layerId};
  const layer = buildWMS(layerId, dateISO).addTo(map);
  layer.setOpacity(1);
  stackState.push({ id: layerId, title: meta.title, layer, opacity:1, visible:true, date: dateISO || todayISO });
  overlays.bringToFront(); drawnItems.bringToFront();
  renderStack();
  showToast(`Added: ${meta.title}`);
}
function renderStack(){
  const c = $('#stack'); c.innerHTML='';
  stackState.slice().reverse().forEach((item, idxReverse)=>{
    const idx = stackState.length-1-idxReverse;
    const el = document.createElement('div'); el.className='stack-item';

    const top = document.createElement('div'); top.className='row-top';
    const title = document.createElement('div'); title.className='title'; title.textContent = item.title;
    const ctrls = document.createElement('div'); ctrls.className='controls';

    const btnUp = document.createElement('button'); btnUp.className='icon-btn'; btnUp.textContent='↑';
    btnUp.onclick = ()=>{ if (idx < stackState.length-1){ const tmp = stackState[idx]; stackState[idx]=stackState[idx+1]; stackState[idx+1]=tmp; readdAll(); } };
    const btnDown = document.createElement('button'); btnDown.className='icon-btn'; btnDown.textContent='↓';
    btnDown.onclick = ()=>{ if (idx > 0){ const tmp = stackState[idx]; stackState[idx]=stackState[idx-1]; stackState[idx-1]=tmp; readdAll(); } };
    const btnVis = document.createElement('button'); btnVis.className='icon-btn'; btnVis.textContent = item.visible?'Hide':'Show';
    btnVis.onclick = ()=>{ item.visible = !item.visible; if (item.visible) item.layer.addTo(map); else map.removeLayer(item.layer); renderStack(); };
    const btnLegend = document.createElement('a'); btnLegend.className='icon-btn'; btnLegend.textContent='Legend'; btnLegend.href=legendURL(item.id); btnLegend.target='_blank';
    btnLegend.addEventListener('click', ()=> setTimeout(()=>showToast('If the legend is blank, this layer may not provide one.'), 120));
    const btnDel = document.createElement('button'); btnDel.className='icon-btn danger'; btnDel.textContent='Remove';
    btnDel.onclick = ()=>{ map.removeLayer(item.layer); stackState.splice(idx,1); renderStack(); };

    ctrls.append(btnUp, btnDown, btnVis, btnLegend, btnDel);
    top.append(title, ctrls);

    const mid = document.createElement('div'); mid.className='row';
    const labOp = document.createElement('label'); labOp.textContent='Opacity';
    const range = document.createElement('input'); range.type='range'; range.min='0'; range.max='1'; range.step='0.05'; range.value=String(item.opacity);
    range.oninput = ()=>{ item.opacity = parseFloat(range.value); item.layer.setOpacity(item.opacity); };

    const labDate = document.createElement('label'); labDate.textContent='Date';
    const date = document.createElement('input'); date.type='date'; date.value=item.date || defaultDateISO;
    date.onchange = ()=>{ item.date = date.value; item.layer.setParams({time: item.date}); };

    mid.append(labOp, range, labDate, date);

    el.append(top, mid);
    c.appendChild(el);
  });

  overlays.bringToFront(); drawnItems.bringToFront();
}
function readdAll(){
  stackState.forEach(s=>{ if (map.hasLayer(s.layer)) map.removeLayer(s.layer); });
  stackState.forEach(s=>{ if (s.visible) s.layer.addTo(map); s.layer.setOpacity(s.opacity); });
  renderStack();
}

$('#addToStack').addEventListener('click', ()=>{
  const sel = $('#catalog');
  const val = sel.value || 'VIIRS_NOAA20_CorrectedReflectance_TrueColor';
  addLayerToStack(val, $('#date').value || todayISO);
});
$('#date').addEventListener('change', ()=>{
  for (let i=stackState.length-1; i>=0; i--){
    if (stackState[i].visible) { stackState[i].date = $('#date').value; stackState[i].layer.setParams({time: stackState[i].date}); break; }
  }
});
$('#globalOpacity').addEventListener('input', ()=>{
  for (let i=stackState.length-1; i>=0; i--){
    if (stackState[i].visible){ stackState[i].opacity = parseFloat($('#globalOpacity').value); stackState[i].layer.setOpacity(stackState[i].opacity); renderStack(); break; }
  }
});
$('#toggleOSM').addEventListener('change', e=>{
  if (e.target.checked) { osm.addTo(map); overlays.bringToFront(); readdAll(); }
  else { map.removeLayer(osm); }
});

/* ==========================
   Compare (Side-by-side)
   ========================== */
let leftL=null, rightL=null, sbs=null;
function activateCompare(){
  if (sbs){ map.removeControl(sbs); sbs=null; }
  if (leftL) map.removeLayer(leftL);
  if (rightL) map.removeLayer(rightL);
  leftL  = buildWMS($('#leftLayer').value,  $('#leftDate').value).addTo(map);
  rightL = buildWMS($('#rightLayer').value, $('#rightDate').value).addTo(map);
  sbs = L.control.sideBySide(leftL, rightL).addTo(map);
  overlays.bringToFront(); drawnItems.bringToFront();
}
$('#activateCompare').addEventListener('click', activateCompare);

/* Populate compare & animate selects once catalog ready */
function syncCompareAnimateSelects(){
  cloneCatalogTo($('#leftLayer'));
  cloneCatalogTo($('#rightLayer'));
  cloneCatalogTo($('#animLayer'));
  $('#leftDate').value = defaultDateISO; $('#rightDate').value = defaultDateISO;
  $('#animStart').value = defaultDateISO; $('#animEnd').value = defaultDateISO;
}

/* Disable Compare when switching tabs (prevents odd layering) */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    $('#'+btn.dataset.tab).classList.add('active');

    if (sbs) { map.removeControl(sbs); sbs = null; }
    if (leftL)  { map.removeLayer(leftL);  leftL  = null; }
    if (rightL) { map.removeLayer(rightL); rightL = null; }
  });
});

/* ==========================
   Animate — build GIF, show with loader
   ========================== */
const preloadOverlay = $('#preloadOverlay');
const preloadText = $('#preloadText');
const preloadProgress = $('#preloadProgress');
const animGif = $('#animGif');
const animGifClose = $('#animGifClose');

function showLoader(msg, p = 0) {
  preloadOverlay.classList.add('open');
  preloadText.textContent = msg;
  preloadProgress.value = p;
}
function hideLoader() {
  preloadOverlay.classList.remove('open');
}

/* Build frame date list */
function buildFramesISO(startISO, endISO, step, units) {
  const frames=[];
  let cur = new Date(startISO);
  const end = new Date(endISO);
  const add = (d, step, units) => {
    if (units==='weeks') d.setUTCDate(d.getUTCDate()+7*step);
    else if (units==='days') d.setUTCDate(d.getUTCDate()+step);
    else if (units==='hours') d.setUTCHours(d.getUTCHours()+step);
    else if (units==='minutes') d.setUTCMinutes(d.getUTCMinutes()+step);
    else if (units==='seconds') d.setUTCSeconds(d.getUTCSeconds()+step);
  };
  while (cur <= end) {
    frames.push(cur.toISOString().slice(0,10));
    add(cur, step, units);
  }
  return frames.length ? frames : [startISO];
}

/* WMS URL for current view (EPSG:3857) */
function wmsGetMapURL(layerId, isoDate, size, bounds){
  const crs = 'EPSG:3857';
  const w = size.x, h = size.y;
  const proj = map.options.crs;
  const sw = proj.project(bounds.getSouthWest());
  const ne = proj.project(bounds.getNorthEast());
  const bbox = [sw.x, sw.y, ne.x, ne.y].join(',');
  const params = [
    'SERVICE=WMS','VERSION=1.3.0','REQUEST=GetMap',
    `LAYERS=${encodeURIComponent(layerId)}`,
    'FORMAT=image/jpeg',
    'TRANSPARENT=false',
    `CRS=${crs}`,
    `BBOX=${bbox}`,
    `WIDTH=${w}`,
    `HEIGHT=${h}`,
    `TIME=${isoDate}`
  ].join('&');
  return GIBS_WMS + params;
}

/* Fetch image for current viewport/date */
function fetchWmsImageForView(layerId, isoDate) {
  const size = map.getSize();
  const bounds = map.getBounds();
  const url = wmsGetMapURL(layerId, isoDate, size, bounds);
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = url;
  });
}

/* Build frames, optional ping-pong, then encode GIF; returns ObjectURL */
async function buildGifForCurrentView({ layerId, startISO, endISO, step, units, speedMs, loop, pingpong }) {
  // 1) Build dates
  let framesISO = buildFramesISO(startISO, endISO, step, units);
  if (pingpong && framesISO.length > 1) {
    const back = framesISO.slice(1, -1).reverse();
    framesISO = framesISO.concat(back);
  }
  if (!framesISO.length) throw new Error('No frames to build');

  // 2) Fetch images
  const imgs = [];
  showLoader(`Fetching 0 / ${framesISO.length} frames…`, 0);
  for (let i = 0; i < framesISO.length; i++) {
    showLoader(`Fetching ${i+1} / ${framesISO.length} (${framesISO[i]})`, Math.round((i+1)*100/framesISO.length));
    try {
      const img = await fetchWmsImageForView(layerId, framesISO[i]);
      imgs.push(img);
    } catch {
      const size = map.getSize();
      const blank = document.createElement('canvas');
      blank.width = size.x; blank.height = size.y;
      imgs.push(blank);
    }
    $('#animCurrent').textContent = framesISO[i];
    $('#animProgress').value = Math.round((i+1)*100/framesISO.length);
  }

  // 3) Encode GIF
  const repeat = loop ? 0 : -1; // 0 = loop forever, -1 = no loop
  const gif = new GIF({
    workers: 2,
    quality: 10,
    workerScript: 'https://cdn.jsdelivr.net/npm/gif.js.optimized@0.2.0/dist/gif.worker.js',
    repeat
  });

  const size = map.getSize();
  const off = document.createElement('canvas');
  off.width = size.x; off.height = size.y;
  const ctx = off.getContext('2d');

  imgs.forEach(img => {
    ctx.clearRect(0, 0, off.width, off.height);
    ctx.drawImage(img, 0, 0, off.width, off.height);
    gif.addFrame(off, { copy: true, delay: Math.max(50, speedMs) });
  });

  return new Promise((resolve, reject) => {
    showLoader('Encoding GIF…', 0);
    gif.on('progress', p => showLoader('Encoding GIF…', Math.round(p * 100)));
    gif.on('finished', blob => {
      hideLoader();
      const url = URL.createObjectURL(blob);
      resolve(url);
    });
    gif.on('abort', () => { hideLoader(); reject(new Error('GIF encoding aborted')); });
    gif.on('error', err => { hideLoader(); reject(err); });
    gif.render();
  });
}

/* Show/hide the GIF overlay (never blocks clicks when hidden) */
let currentGifURL = null;
function showGif(url) {
  if (currentGifURL) URL.revokeObjectURL(currentGifURL);
  currentGifURL = url;
  animGif.src = url;
  animGif.setAttribute('data-visible', '1');
  animGifClose.style.display = 'block';
}
function hideGif() {
  animGif.removeAttribute('data-visible');
  animGif.src = '';
  animGifClose.style.display = 'none';
  if (currentGifURL) { URL.revokeObjectURL(currentGifURL); currentGifURL = null; }
}
animGifClose.addEventListener('click', hideGif);

/* Animate controls */
$('#animPlay').addEventListener('click', async () => {
  hideGif();
  const layerId = $('#animLayer').value || 'VIIRS_NOAA20_CorrectedReflectance_TrueColor';
  const startISO = $('#animStart').value || defaultDateISO;
  const endISO   = $('#animEnd').value   || defaultDateISO;
  const step     = Math.max(1, parseInt($('#animStep').value || '1', 10));
  const units    = $('#animUnits').value;
  const speedMs  = Math.max(50, parseInt($('#animSpeed').value || '500', 10));
  const loop     = $('#animLoop').checked;
  const pingpong = $('#animPingPong').checked;

  try {
    showLoader('Preparing frames…', 0);
    const url = await buildGifForCurrentView({ layerId, startISO, endISO, step, units, speedMs, loop, pingpong });
    hideLoader();
    showGif(url);
    showToast('Animation ready.');
    $('#animDownloadGIF').disabled = false;
    $('#animDownloadGIF').dataset.gifUrl = url;
  } catch (e) {
    hideLoader();
    console.warn(e);
    showToast('Failed to build animation.');
  }
});
$('#animPrebuild').addEventListener('click', async () => {
  hideGif();
  const layerId = $('#animLayer').value || 'VIIRS_NOAA20_CorrectedReflectance_TrueColor';
  const startISO = $('#animStart').value || defaultDateISO;
  const endISO   = $('#animEnd').value   || defaultDateISO;
  const step     = Math.max(1, parseInt($('#animStep').value || '1', 10));
  const units    = $('#animUnits').value;
  const speedMs  = Math.max(50, parseInt($('#animSpeed').value || '500', 10));
  const loop     = $('#animLoop').checked;
  const pingpong = $('#animPingPong').checked;

  try {
    showLoader('Preparing frames…', 0);
    const url = await buildGifForCurrentView({ layerId, startISO, endISO, step, units, speedMs, loop, pingpong });
    hideLoader();
    $('#animDownloadGIF').disabled = false;
    $('#animDownloadGIF').dataset.gifUrl = url;
    showToast('GIF prebuilt. Press Play to display or Download GIF.');
  } catch (e) {
    hideLoader();
    console.warn(e);
    showToast('Failed to prebuild GIF.');
  }
});
$('#animPause').addEventListener('click', hideGif);
$('#animDownloadGIF').addEventListener('click', () => {
  const url = $('#animDownloadGIF').dataset.gifUrl;
  if (!url) { showToast('No GIF to download. Press Play first.'); return; }
  const a = Object.assign(document.createElement('a'), {
    href: url,
    download: `animation_${new Date().toISOString().slice(0,10)}.gif`
  });
  a.click();
});

/* Animate search filters the layer list */
function filterSelectOptions(selectEl, query) {
  const q = (query || '').trim().toLowerCase();
  const tmp = document.createElement('select');

  const addGroup = (label, items) => {
    if (!items.length) return;
    const og = document.createElement('optgroup'); og.label = label;
    items.forEach(it => {
      const o = document.createElement('option');
      o.value = it.name; o.textContent = it.title;
      og.appendChild(o);
    });
    tmp.appendChild(og);
  };

  const matches = (it) => it.title.toLowerCase().includes(q) || it.name.toLowerCase().includes(q);

  const pop = popularList.filter(matches);
  addGroup('Popular', pop);

  let currentGroup = null;
  catalogList
    .filter(it => !popularList.some(p => p.name === it.name))
    .filter(matches)
    .forEach(it => {
      if (it.group !== currentGroup) {
        const og = document.createElement('optgroup'); og.label = it.group;
        tmp.appendChild(og); currentGroup = it.group;
      }
      const o = document.createElement('option');
      o.value = it.name; o.textContent = it.title;
      tmp.lastChild.appendChild(o);
    });

  if (tmp.children.length) selectEl.innerHTML = tmp.innerHTML;
}
$('#animFilter').addEventListener('input', () => {
  filterSelectOptions($('#animLayer'), $('#animFilter').value);
});

/* ==========================
   Learn Drawer + Modal
   ========================== */
const LEARN_HTML = `
<div class="learn-section">
  <h4>Satellites</h4>
  <ul>
    <li><b>VIIRS (SNPP / NOAA-20)</b> — ~375 m visible; daily global.</li>
    <li><b>MODIS (Terra/Aqua)</b> — 250–1000 m; multi-decade time series.</li>
  </ul>
</div>
<div class="learn-section">
  <h4>Layer Families</h4>
  <ul>
    <li><b>True Color</b>: photo-like composites.</li>
    <li><b>Infrared (IR)</b>: thermal info (cloud tops, hotspots).</li>
    <li><b>Fires/Hotspots</b>: active fire detections.</li>
    <li><b>Snow & Ice</b>: snow cover, sea ice concentration.</li>
    <li><b>Aerosol/Atmosphere</b>: AOD, SO₂, NO₂, ozone.</li>
    <li><b>Night Lights</b>: DNB night-time radiance.</li>
    <li><b>Ocean/SST/Color</b>: sea surface temperature, chlorophyll.</li>
  </ul>
</div>
<div class="learn-section">
  <h4>Tools</h4>
  <ul>
    <li><b>Explore</b>: build/reorder a multi-layer stack; per-layer date/opacity.</li>
    <li><b>Compare</b>: swipe two layers/dates side-by-side.</li>
    <li><b>Animate</b>: builds a GIF of the current viewport.</li>
    <li><b>Analyze</b>: draw AOIs; export/import GeoJSON; snapshot.</li>
  </ul>
</div>
<div class="learn-section">
  <h4>Tips</h4>
  <ul>
    <li>Many products are daily; sub-daily steps may repeat frames.</li>
    <li>GIF uses the current viewport; pan/zoom before building.</li>
    <li>True Color base + themed overlays keeps views readable.</li>
  </ul>
</div>
`;
function renderLearnTargets(){
  $('#learnContent').innerHTML = LEARN_HTML;
  $('#learnModalContent').innerHTML = LEARN_HTML;
}
renderLearnTargets();

function toggleLearn(open){
  const drawer = $('#learnDrawer');
  if (open===undefined) drawer.classList.toggle('open');
  else drawer.classList.toggle('open', open);
  if (drawer.classList.contains('open')) drawer.focus();
}
$('#openLearn').addEventListener('click', ()=>toggleLearn());
$('#closeLearn').addEventListener('click', ()=>toggleLearn(false));

document.addEventListener('keydown', (e) => {
  const ae = document.activeElement;
  const isTyping = ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.isContentEditable);
  const isQuestionMark = (e.key === '?' || (e.shiftKey && e.key === '/'));
  if (!isTyping && isQuestionMark) {
    e.preventDefault();
    const modalOpen = $('#learnModal').classList.contains('open');
    if (modalOpen) {
      $('#learnModal').classList.remove('open');
    } else {
      toggleLearn();
    }
  }
  if (e.key === 'Escape') {
    toggleLearn(false);
    $('#learnModal').classList.remove('open');
  }
});

$('#openLearnModal').addEventListener('click', ()=>$('#learnModal').classList.add('open'));
$('#closeLearnModal').addEventListener('click', ()=>$('#learnModal').classList.remove('open'));
$('#learnModal').addEventListener('click', (e)=>{ if (e.target.id==='learnModal') $('#learnModal').classList.remove('open'); });

$('#learnSearch').addEventListener('input', ()=>{
  const q = $('#learnSearch').value.toLowerCase();
  document.querySelectorAll('.learn-section').forEach(sec=>{
    sec.style.display = sec.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
});

/* ==========================
   Analyze / Export / Snapshot
   ========================== */
$('#exportGeoJSON').addEventListener('click', ()=>{
  const fc = drawnItems.toGeoJSON();
  const blob = new Blob([JSON.stringify(fc, null, 2)], {type:'application/geo+json'});
  const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'aoi.geojson'}); a.click();
  URL.revokeObjectURL(a.href);
});
$('#importGeoJSON').addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0]; if (!f) return;
  try { const txt=await f.text(); L.geoJSON(JSON.parse(txt)).eachLayer(l=>drawnItems.addLayer(l)); $('#aoiStatus').textContent='AOI imported'; }
  catch { $('#aoiStatus').textContent='Invalid GeoJSON'; }
  ev.target.value='';
});
function snapshot(){
  domtoimage.toPng($('#map')).then(url=>{
    const a = Object.assign(document.createElement('a'), {href:url, download:`map_${new Date().toISOString().slice(0,10)}.png`}); a.click();
  });
}
$('#snapshotBtn').addEventListener('click', snapshot);
$('#snapshotBtn2').addEventListener('click', snapshot);

/* ==========================
   Bookmarks
   ========================== */
const BM_KEY='oeo_bookmarks_v3';
function loadBMs(){
  const arr = JSON.parse(localStorage.getItem(BM_KEY) || '[]');
  const sel = $('#bookmarkLoad'); sel.innerHTML='<option value="">Load…</option>';
  arr.forEach((b,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=b.name; sel.appendChild(o); });
  return arr;
}
function saveBM(){
  const arr=loadBMs();
  const name = prompt('Bookmark name?', `View ${arr.length+1}`) || `View ${arr.length+1}`;
  arr.push({ name, center: map.getCenter(), zoom: map.getZoom(), tab: document.querySelector('.tab-btn.active')?.dataset.tab || 'tab-explore' });
  localStorage.setItem(BM_KEY, JSON.stringify(arr)); loadBMs();
}
$('#bookmarkSave').addEventListener('click', saveBM);
$('#bookmarkLoad').addEventListener('change', ()=>{
  const arr=loadBMs(); const i=parseInt($('#bookmarkLoad').value,10);
  if (!isNaN(i) && arr[i]){ const b=arr[i]; map.setView(b.center,b.zoom); if (b.tab){ document.querySelector(`.tab-btn[data-tab="${b.tab}"]`)?.click(); } }
  $('#bookmarkLoad').value='';
});
loadBMs();

/* ==========================
   Safety resets on load
   ========================== */
hideGif();
preloadOverlay.classList.remove('open');
$('#learnModal').classList.remove('open');
$('#learnDrawer').classList.remove('open');

/* ==========================
   Init
   ========================== */
populateCatalog();
</script>
</body>
</html>
